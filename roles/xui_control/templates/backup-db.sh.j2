#!/usr/bin/env python3
import boto3
import subprocess
import sys
import logging
from datetime import datetime

# Setup logging for systemd journal
logging.basicConfig(
    level=logging.INFO,
    format='%(levelname)s: %(message)s'
)
logger = logging.getLogger('backup-db')

def main():
    logger.info("Starting database backup")

    # Stop x-ui service
    logger.info("Stopping x-ui service")
    result = subprocess.run(
        ['systemctl', 'stop', '{{ xui_control_xui_service }}'],
        capture_output=True,
        text=True
    )
    if result.returncode != 0:
        logger.warning(f"Failed to stop x-ui: {result.stderr}")
    else:
        logger.info("x-ui service stopped successfully")

    try:
        # Upload to R2
        logger.info("Connecting to R2 storage")
        s3 = boto3.client(
            's3',
            endpoint_url='{{ r2_endpoint }}',
            aws_access_key_id='{{ r2_access_key }}',
            aws_secret_access_key='{{ r2_secret_key }}'
        )

        filename = f"x-ui-{datetime.now().strftime('%Y-%m-%d_%H%M%S')}.db"
        logger.info(f"Uploading database as {filename}")

        s3.upload_file('{{ xui_control_db_path }}', '{{ r2_bucket }}', filename)
        logger.info(f"Backup completed successfully: {filename}")

    except Exception as e:
        logger.error(f"Backup failed: {str(e)}")
        sys.exit(1)

    finally:
        # Always start x-ui service back
        logger.info("Starting x-ui service")
        result = subprocess.run(
            ['systemctl', 'start', '{{ xui_control_xui_service }}'],
            capture_output=True,
            text=True
        )
        if result.returncode != 0:
            logger.error(f"Failed to start x-ui: {result.stderr}")
            sys.exit(1)
        else:
            logger.info("x-ui service started successfully")

if __name__ == '__main__':
    main()
