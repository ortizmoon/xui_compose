global
    log stdout format raw local0

defaults
    log     global
    mode    tcp
    option  tcplog
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout tunnel  1h

# --- L4 entrypoint: route by SNI ---
frontend ft_main
    bind *:443
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }

    use_backend bk_xray    if { req.ssl_sni -i apple.com }
    use_backend bk_ssh_tls if { req.ssl_sni -i connect.${DOMAIN} }
    use_backend bk_panel   if { req.ssl_sni -i rcn.${DOMAIN} }
    default_backend bk_panel

# --- TLS termination for SSH-over-TLS ---
frontend ft_ssh_unwrap
    bind 127.0.0.1:4443 ssl crt /etc/letsencrypt/live/${DOMAIN}/bundle.pem
    default_backend bk_sshd

# --- backends ---
backend bk_xray
    server xray 127.0.0.1:22888

backend bk_ssh_tls
    server loopback 127.0.0.1:4443

backend bk_sshd
    server sshd 127.0.0.1:22

backend bk_panel
    server panel 127.0.0.1:6969
